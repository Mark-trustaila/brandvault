<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BrandVault - Trademark Portfolio Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: #ffffff;
      color: #37352f;
      font-size: 14px;
      line-height: 1.5;
    }

    .container {
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    /* SIDEBAR */
    .sidebar {
      width: 240px;
      background: #fbfbfa;
      border-right: 1px solid #e8e5e0;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      padding: 24px 16px;
    }

    .sidebar-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 24px;
    }

    .sidebar-logo {
      width: 28px;
      height: 28px;
      background: #37352f;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #ffffff;
      font-weight: 700;
      font-size: 12px;
    }

    .sidebar-org {
      display: flex;
      flex-direction: column;
    }

    .sidebar-org-name {
      font-weight: 600;
      font-size: 13px;
      color: #37352f;
    }

    .sidebar-org-sub {
      font-size: 11px;
      color: #9b9a97;
    }

    .sidebar-nav {
      flex: 1;
    }

    .sidebar-section-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #9b9a97;
      margin-bottom: 12px;
      margin-top: 20px;
      font-weight: 600;
    }

    .nav-items {
      list-style: none;
    }

    .nav-item {
      margin-bottom: 8px;
    }

    .nav-link {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 12px;
      border-radius: 6px;
      cursor: pointer;
      color: #37352f;
      text-decoration: none;
      font-size: 14px;
      transition: background 0.2s;
    }

    .nav-link:hover {
      background: #ece9e3;
    }

    .nav-link.active {
      background: #e8e5e0;
      font-weight: 500;
    }

    .nav-icon {
      width: 16px;
      height: 16px;
      flex-shrink: 0;
    }

    .sidebar-footer {
      display: flex;
      align-items: center;
      gap: 12px;
      padding-top: 16px;
      border-top: 1px solid #e8e5e0;
    }

    .user-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #37352f;
      color: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 12px;
      flex-shrink: 0;
    }

    .user-info {
      display: flex;
      flex-direction: column;
    }

    .user-name {
      font-size: 13px;
      font-weight: 500;
      color: #37352f;
    }

    .user-role {
      font-size: 11px;
      color: #9b9a97;
    }

    /* MAIN CONTENT */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .top-bar {
      background: #ffffff;
      border-bottom: 1px solid #e8e5e0;
      padding: 16px 32px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      height: 80px;
    }

    .top-bar-left {
      display: flex;
      flex-direction: column;
    }

    .page-title {
      font-size: 28px;
      font-weight: 700;
      color: #37352f;
      margin-bottom: 4px;
    }

    .page-subtitle {
      font-size: 12px;
      color: #9b9a97;
    }

    .top-bar-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .status-badge {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      border: 1px solid #0f7b6c;
      border-radius: 6px;
      background: #ffffff;
      font-size: 13px;
      font-weight: 500;
      color: #0f7b6c;
    }

    .status-check {
      width: 16px;
      height: 16px;
    }

    .btn {
      padding: 10px 20px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: background 0.2s;
    }

    .btn-primary {
      background: #37352f;
      color: #ffffff;
    }

    .btn-primary:hover {
      background: #2a282a;
    }

    .btn-secondary {
      background: #f5f5f5;
      color: #37352f;
      border: 1px solid #e8e5e0;
    }

    .btn-secondary:hover {
      background: #ece9e3;
    }

    /* CONTENT AREA */
    .content-wrapper {
      flex: 1;
      display: flex;
      overflow: hidden;
    }

    .content-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      overflow-x: hidden;
    }

    /* STATS ROW */
    .stats-row {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      padding: 24px 32px;
      background: #ffffff;
      border-bottom: 1px solid #e8e5e0;
    }

    .stat-card {
      background: #ffffff;
      border: 1px solid #e8e5e0;
      border-radius: 8px;
      padding: 20px;
      position: relative;
    }

    .stat-card.alert {
      border-top: 3px solid #eb5757;
    }

    .stat-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #9b9a97;
      margin-bottom: 12px;
      font-weight: 600;
    }

    .stat-number {
      font-size: 32px;
      font-weight: 700;
      color: #37352f;
      margin-bottom: 8px;
    }

    .stat-card.alert .stat-number {
      color: #eb5757;
    }

    .stat-subtitle {
      font-size: 12px;
      color: #6b6b6b;
    }

    .stat-subtitle.success {
      color: #0f7b6c;
    }

    .stat-subtitle.warning {
      color: #f2994a;
    }

    .stat-subtitle.danger {
      color: #eb5757;
    }

    /* TABS */
    .tabs-bar {
      display: flex;
      border-bottom: 1px solid #e8e5e0;
      background: #ffffff;
      padding: 0 32px;
    }

    .tab {
      padding: 16px 20px;
      border-bottom: 2px solid transparent;
      cursor: pointer;
      font-size: 14px;
      color: #6b6b6b;
      transition: all 0.2s;
      border-bottom-color: #e8e5e0;
    }

    .tab.active {
      color: #37352f;
      font-weight: 600;
      border-bottom-color: #37352f;
    }

    /* TAB CONTENT */
    .tab-content {
      display: none;
      flex: 1;
      overflow-y: auto;
      padding: 24px 32px;
    }

    .tab-content.active {
      display: block;
    }

    .section-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
    }

    .section-title {
      font-size: 16px;
      font-weight: 600;
      color: #37352f;
    }

    .section-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .section-dot.red {
      background: #eb5757;
    }

    .section-dot.orange {
      background: #f2994a;
    }

    .section-dot.blue {
      background: #2e6b8a;
    }

    .section-dot.green {
      background: #0f7b6c;
    }

    .section-dot.purple {
      background: #8b5cf6;
    }

    .badge {
      background: #e8e5e0;
      color: #37352f;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    /* ACTION ITEMS */
    .action-item {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px;
      background: #ffffff;
      border: 1px solid #e8e5e0;
      border-radius: 6px;
      margin-bottom: 12px;
      border-left: 4px solid;
    }

    .action-item.critical {
      border-left-color: #eb5757;
    }

    .action-item.warning {
      border-left-color: #f2994a;
    }

    .action-item.info {
      border-left-color: #2e6b8a;
    }

    .action-badge {
      width: 40px;
      height: 40px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #ffffff;
      font-weight: 600;
      font-size: 12px;
      flex-shrink: 0;
    }

    .action-content {
      flex: 1;
    }

    .action-mark {
      font-weight: 600;
      color: #37352f;
      margin-bottom: 2px;
    }

    .action-description {
      font-size: 13px;
      color: #6b6b6b;
    }

    .action-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .countdown-badge {
      background: #0f7b6c;
      color: #ffffff;
      padding: 6px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      white-space: nowrap;
    }

    .action-registry {
      font-size: 11px;
      color: #9b9a97;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
    }

    /* MARK FAMILY */
    .mark-family {
      border: 1px solid #e8e5e0;
      border-radius: 6px;
      margin-bottom: 16px;
      overflow: hidden;
    }

    .mark-family-header {
      padding: 16px;
      background: #ffffff;
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      border-bottom: 1px solid #e8e5e0;
    }

    .mark-family.expanded .mark-family-header {
      border-bottom: 1px solid #ccc;
    }

    .mark-family-header:hover {
      background: #f9f8f7;
    }

    .mark-family-badge {
      width: 36px;
      height: 36px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #ffffff;
      font-weight: 600;
      font-size: 11px;
      flex-shrink: 0;
    }

    .mark-family-info {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .mark-family-name {
      font-weight: 600;
      color: #37352f;
      margin-bottom: 2px;
    }

    .mark-family-count {
      font-size: 12px;
      color: #9b9a97;
    }

    .mark-expand-arrow {
      width: 16px;
      height: 16px;
      transition: transform 0.2s;
      flex-shrink: 0;
    }

    .mark-family.expanded .mark-expand-arrow {
      transform: rotate(90deg);
    }

    .mark-classes {
      display: none;
    }

    .mark-family.expanded .mark-classes {
      display: block;
    }

    .mark-class-group {
      background: #f8fbfd;
      padding: 12px 16px;
      border-bottom: 1px solid #e8e5e0;
    }

    .mark-class-header {
      font-weight: 600;
      color: #37352f;
      margin-bottom: 12px;
      font-size: 13px;
    }

    .mark-class-count {
      background: #e8e5e0;
      color: #37352f;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 8px;
    }

    .mark-registration {
      background: #ffffff;
      padding: 12px 16px;
      border-bottom: 1px solid #e8e5e0;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .mark-registration:last-child {
      border-bottom: none;
    }

    .mark-reg-name {
      font-weight: 500;
      color: #37352f;
      margin-bottom: 2px;
    }

    .mark-reg-app {
      font-size: 12px;
      color: #9b9a97;
    }

    .mark-reg-content {
      flex: 1;
    }

    .mark-reg-status {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 4px;
      font-weight: 600;
      white-space: nowrap;
    }

    .status-registered {
      background: #e6f3f0;
      color: #0f7b6c;
    }

    .status-pending {
      background: #fdecd8;
      color: #f2994a;
    }

    .status-published {
      background: #d4e3f0;
      color: #2e6b8a;
    }

    .status-expired {
      background: #f5d5d5;
      color: #991b1b;
    }

    .status-abandoned {
      background: #ece9e3;
      color: #6b6b6b;
    }

    /* REGISTRY CARDS */
    .registry-card {
      border: 1px solid #e8e5e0;
      border-radius: 6px;
      margin-bottom: 16px;
      overflow: hidden;
    }

    .registry-card-header {
      padding: 16px;
      background: #ffffff;
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
    }

    .registry-card-header:hover {
      background: #f9f8f7;
    }

    .registry-badge {
      width: 36px;
      height: 36px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #ffffff;
      font-weight: 600;
      font-size: 11px;
      flex-shrink: 0;
    }

    .registry-info {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .registry-name {
      font-weight: 600;
      color: #37352f;
      margin-bottom: 2px;
    }

    .registry-subtitle {
      font-size: 12px;
      color: #9b9a97;
    }

    .registry-count {
      background: #e8e5e0;
      color: #37352f;
      padding: 6px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      white-space: nowrap;
    }

    .registry-expand {
      width: 16px;
      height: 16px;
      transition: transform 0.2s;
      flex-shrink: 0;
    }

    .registry-card.expanded .registry-expand {
      transform: rotate(90deg);
    }

    .registry-marks {
      display: none;
    }

    .registry-card.expanded .registry-marks {
      display: block;
    }

    .registry-mark-item {
      padding: 12px 16px;
      background: #f9f8f7;
      border-bottom: 1px solid #e8e5e0;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .registry-mark-item:last-child {
      border-bottom: none;
    }

    /* PIPELINE VISUALIZATION */
    .pipeline-bubbles {
      display: flex;
      justify-content: space-around;
      align-items: flex-end;
      margin: 40px 0;
      gap: 20px;
    }

    .bubble-group {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }

    .bubble {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 24px;
      color: #ffffff;
    }

    .bubble-filed {
      background: #37352f;
    }

    .bubble-published {
      background: #2e6b8a;
    }

    .bubble-pending {
      background: #f2994a;
    }

    .bubble-registered {
      background: #0f7b6c;
    }

    .bubble-opposed {
      background: #eb5757;
    }

    .bubble-expired {
      background: #991b1b;
    }

    .bubble-label {
      font-size: 12px;
      color: #6b6b6b;
      text-align: center;
      font-weight: 500;
    }

    .class-bars {
      margin-top: 40px;
    }

    .class-bar-item {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .class-bar-label {
      width: 140px;
      font-weight: 500;
      color: #37352f;
      font-size: 13px;
    }

    .class-bar {
      flex: 1;
      height: 28px;
      background: #e8e5e0;
      border-radius: 4px;
      overflow: hidden;
      position: relative;
    }

    .class-bar-fill {
      height: 100%;
      background: #37352f;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 12px;
      color: #ffffff;
      font-size: 12px;
      font-weight: 600;
    }

    /* RIGHT PANEL */
    .right-panel {
      width: 320px;
      background: #fbfbfa;
      border-left: 1px solid #e8e5e0;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      padding: 24px 16px;
    }

    .panel-section {
      margin-bottom: 24px;
    }

    .panel-section-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #9b9a97;
      margin-bottom: 12px;
      font-weight: 600;
    }

    .alert-box {
      background: #ffffff;
      border: 1px solid #e8e5e0;
      border-left: 4px solid #f2994a;
      border-radius: 6px;
      padding: 16px;
      margin-bottom: 16px;
    }

    .alert-box-title {
      font-weight: 600;
      color: #37352f;
      margin-bottom: 8px;
      font-size: 13px;
    }

    .alert-box-text {
      font-size: 12px;
      color: #6b6b6b;
      line-height: 1.6;
    }

    .insight-box {
      background: #ffffff;
      border: 1px solid #e8e5e0;
      border-radius: 6px;
      padding: 16px;
      margin-bottom: 16px;
    }

    .insight-box-title {
      font-weight: 600;
      color: #37352f;
      margin-bottom: 8px;
      font-size: 13px;
    }

    .insight-box-text {
      font-size: 12px;
      color: #6b6b6b;
      line-height: 1.6;
    }

    .item-list {
      list-style: none;
    }

    .item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 0;
      border-bottom: 1px solid #e8e5e0;
    }

    .item:last-child {
      border-bottom: none;
    }

    .item-badge {
      width: 32px;
      height: 32px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #ffffff;
      font-weight: 600;
      font-size: 10px;
      flex-shrink: 0;
    }

    .item-info {
      flex: 1;
    }

    .item-title {
      font-weight: 500;
      color: #37352f;
      margin-bottom: 2px;
      font-size: 13px;
    }

    .item-subtitle {
      font-size: 11px;
      color: #9b9a97;
    }

    .item-count {
      background: #0f7b6c;
      color: #ffffff;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
    }

    .loading, .error {
      text-align: center;
      padding: 60px 20px;
      color: #6b6b6b;
    }

    .error {
      color: #eb5757;
    }

    @media (max-width: 1400px) {
      .right-panel {
        display: none;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- SIDEBAR -->
    <div class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">BV</div>
        <div class="sidebar-org">
          <div class="sidebar-org-name">AiLA</div>
          <div class="sidebar-org-sub">ACME CO LEGAL</div>
        </div>
      </div>

      <nav class="sidebar-nav">
        <div class="sidebar-section-label">PORTFOLIO</div>
        <ul class="nav-items">
          <li class="nav-item">
            <a class="nav-link active" onclick="switchNav('dashboard')">
              <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="7" height="7"></rect>
                <rect x="14" y="3" width="7" height="7"></rect>
                <rect x="14" y="14" width="7" height="7"></rect>
                <rect x="3" y="14" width="7" height="7"></rect>
              </svg>
              Dashboard
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" onclick="switchNav('search')">
              <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
              </svg>
              Search
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" onclick="switchNav('calendar')">
              <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="18" rx="2"></rect>
                <path d="M16 2v4M8 2v4M3 10h18"></path>
              </svg>
              Calendar
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" onclick="switchNav('alerts')">
              <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
              </svg>
              Alerts
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" onclick="switchNav('settings')">
              <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M12 1v6m0 6v6M4.22 4.22l4.24 4.24m3.08 3.08l4.24 4.24M1 12h6m6 0h6m-1.78 7.78l-4.24-4.24m-3.08-3.08l-4.24-4.24"></path>
              </svg>
              Settings
            </a>
          </li>
        </ul>
      </nav>

      <div class="sidebar-footer">
        <div class="user-avatar">MK</div>
        <div class="user-info">
          <div class="user-name">Mark Kingsley</div>
          <div class="user-role">Legal Counsel</div>
        </div>
      </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main-content">
      <!-- TOP BAR -->
      <div class="top-bar">
        <div class="top-bar-left">
          <div class="page-title">BrandVault</div>
          <div class="page-subtitle">Trademark Portfolio Intelligence</div>
        </div>
        <div class="top-bar-right">
          <div class="status-badge">
            <svg class="status-check" viewBox="0 0 24 24" fill="currentColor">
              <circle cx="12" cy="12" r="10"></circle>
              <path d="M9 12l2 2 4-4" stroke="#ffffff" stroke-width="2" fill="none"></path>
            </svg>
            LawPanel Live
          </div>
          <button class="btn btn-secondary" onclick="showExportMenu()">Report</button>
        </div>
      </div>

      <!-- CONTENT WRAPPER -->
      <div class="content-wrapper">
        <div class="content-main">
          <!-- STATS ROW -->
          <div class="stats-row" id="stats-row"></div>

          <!-- TABS -->
          <div class="tabs-bar">
            <div class="tab active" onclick="switchTab('actions')">Actions Required</div>
            <div class="tab" onclick="switchTab('marks')">By Mark</div>
            <div class="tab" onclick="switchTab('pipeline')">Pipeline</div>
            <div class="tab" onclick="switchTab('registry')">By Registry</div>
          </div>

          <!-- TAB: ACTIONS REQUIRED -->
          <div class="tab-content active" id="tab-actions"></div>

          <!-- TAB: BY MARK -->
          <div class="tab-content" id="tab-marks"></div>

          <!-- TAB: PIPELINE -->
          <div class="tab-content" id="tab-pipeline"></div>

          <!-- TAB: BY REGISTRY -->
          <div class="tab-content" id="tab-registry"></div>
        </div>

        <!-- RIGHT PANEL -->
        <div class="right-panel" id="right-panel"></div>
      </div>
    </div>
  </div>

  <script>
    // STATE MANAGEMENT
    let allData = [];
    let transformedData = {};
    let currentTab = 'actions';
    let expandedMarks = new Set();
    let expandedRegistries = new Set();

    // COLOR PALETTE FOR BADGES
    const colors = [
      '#37352f', '#f2994a', '#0f7b6c', '#2e6b8a', '#eb5757',
      '#8b5cf6', '#6b6b6b', '#d4672e', '#1a8f5f', '#5a7ba1'
    ];

    function getColorForIndex(index) {
      return colors[index % colors.length];
    }

    // UTILITY FUNCTIONS
    function daysTo(dateStr) {
      if (!dateStr) return null;
      const date = new Date(dateStr);
      const today = new Date();
      const diff = Math.ceil((date - today) / (1000 * 60 * 60 * 24));
      return diff;
    }

    function fmtDate(dateStr) {
      if (!dateStr) return '-';
      return new Date(dateStr).toLocaleDateString('en-US', {
        year: 'numeric', month: 'short', day: 'numeric'
      });
    }

    function getDaysLabel(days) {
      if (days === null) return '';
      if (days < 0) return Math.abs(days) + 'd ago';
      if (days === 0) return 'Today';
      return days + 'd';
    }

    function getInitials(text) {
      return text.split(' ').map(w => w[0]).join('').toUpperCase().slice(0, 3);
    }

    // TRANSFORM DATA
    function transformData(trademarks) {
      const grouped = {};

      trademarks.forEach((tm, idx) => {
        const markKey = tm.mark_text.toLowerCase();
        if (!grouped[markKey]) {
          grouped[markKey] = {
            mark_text: tm.mark_text,
            color: getColorForIndex(idx),
            registrations: []
          };
        }
        grouped[markKey].registrations.push(tm);
      });

      return grouped;
    }

    function groupByMark(trademarks) {
      const byMark = {};
      trademarks.forEach(tm => {
        const key = tm.mark_text.toLowerCase();
        if (!byMark[key]) {
          byMark[key] = {
            mark_text: tm.mark_text,
            registrations: []
          };
        }
        byMark[key].registrations.push(tm);
      });
      return Object.values(byMark);
    }

    function groupByClass(registrations) {
      const byClass = {};
      registrations.forEach(reg => {
        const classes = reg.good_and_services || [];
        classes.forEach(cls => {
          const classNum = cls.search_class?.number || 'Unknown';
          if (!byClass[classNum]) {
            byClass[classNum] = {
              class: classNum,
              className: cls.search_class?.name || 'Unknown Class',
              registrations: []
            };
          }
          if (!byClass[classNum].registrations.find(r => r.id === reg.id)) {
            byClass[classNum].registrations.push(reg);
          }
        });
      });
      return Object.values(byClass).sort((a, b) => a.class - b.class);
    }

    function groupByRegistry(trademarks) {
      const byRegistry = {};
      trademarks.forEach(tm => {
        const reg = tm.registry_name || 'Unknown';
        if (!byRegistry[reg]) {
          byRegistry[reg] = {
            registry_name: reg,
            registry_description: tm.registry_description || reg,
            trademarks: []
          };
        }
        byRegistry[reg].trademarks.push(tm);
      });
      return Object.values(byRegistry).sort((a, b) =>
        a.registry_name.localeCompare(b.registry_name)
      );
    }

    // CALCULATE ACTION ITEMS
    function getActionsRequired(trademarks) {
      const actions = [];

      trademarks.forEach(tm => {
        // Renewal action
        if (tm.expiry_date) {
          const days = daysTo(tm.expiry_date);
          if (days !== null && days > 0 && days <= 365) {
            actions.push({
              type: 'renewal',
              mark: tm.mark_text,
              description: `Renewal due in ${days} days`,
              daysLeft: days,
              registry: tm.registry_name,
              color: tm.color || '#37352f',
              severity: days <= 30 ? 'critical' : days <= 90 ? 'warning' : 'info'
            });
          }
        }

        // Office action
        if (tm.office_action_date) {
          const days = daysTo(tm.office_action_date);
          if (days !== null && days > 0) {
            actions.push({
              type: 'office_action',
              mark: tm.mark_text,
              description: 'Office action response due',
              daysLeft: days,
              registry: tm.registry_name,
              color: tm.color || '#37352f',
              severity: days <= 30 ? 'critical' : 'warning'
            });
          }
        }
      });

      return actions.sort((a, b) => a.daysLeft - b.daysLeft);
    }

    // RENDER FUNCTIONS
    function renderStats() {
      const stats = document.getElementById('stats-row');
      const total = allData.length;
      const unique = new Set(allData.map(t => t.mark_text.toLowerCase())).size;
      const registered = allData.filter(t => t.status === 'registered').length;
      const pending = allData.filter(t => t.status === 'pending' || t.status === 'published').length;
      const actions = getActionsRequired(allData);

      stats.innerHTML = '';

      const cards = [
        { label: 'TOTAL MARKS', number: unique, subtitle: `${total} total registrations` },
        { label: 'REGISTERED', number: registered, subtitle: 'Active protection', subtitleClass: 'success' },
        { label: 'PENDING / PUBLISHED', number: pending, subtitle: 'In prosecution', subtitleClass: 'warning' },
        { label: 'NEEDS ACTION', number: actions.length, subtitle: 'Renewals & office actions', alert: true, subtitleClass: 'danger' }
      ];

      cards.forEach(card => {
        const el = document.createElement('div');
        el.className = 'stat-card' + (card.alert ? ' alert' : '');
        el.innerHTML = `
          <div class="stat-label">${card.label}</div>
          <div class="stat-number">${card.number}</div>
          <div class="stat-subtitle ${card.subtitleClass || ''}">${card.subtitle}</div>
        `;
        stats.appendChild(el);
      });
    }

    function renderActions() {
      const container = document.getElementById('tab-actions');
      const actions = getActionsRequired(allData);

      if (actions.length === 0) {
        container.innerHTML = '<div class="loading">No actions required at this time.</div>';
        return;
      }

      const header = document.createElement('div');
      header.className = 'section-header';
      header.innerHTML = `
        <div class="section-dot red"></div>
        <div class="section-title">Action required</div>
        <div class="badge">${actions.length}</div>
      `;
      container.appendChild(header);

      const list = document.createElement('div');
      actions.forEach(action => {
        const item = document.createElement('div');
        item.className = `action-item ${action.severity}`;
        item.innerHTML = `
          <div class="action-badge" style="background: ${action.color}">
            ${getInitials(action.mark)}
          </div>
          <div class="action-content">
            <div class="action-mark">${action.mark}</div>
            <div class="action-description">${action.description}</div>
          </div>
          <div class="action-right">
            <div class="countdown-badge">${getDaysLabel(action.daysLeft)}</div>
            <div class="action-registry">${action.registry}</div>
          </div>
        `;
        list.appendChild(item);
      });
      container.appendChild(list);
    }

    function renderMarks() {
      const container = document.getElementById('tab-marks');
      const marks = groupByMark(allData);

      if (marks.length === 0) {
        container.innerHTML = '<div class="loading">No trademarks found.</div>';
        return;
      }

      const header = document.createElement('div');
      header.className = 'section-header';
      header.innerHTML = `
        <div class="section-dot blue"></div>
        <div class="section-title">Trademark Portfolio</div>
        <div class="badge">${marks.length}</div>
      `;
      container.appendChild(header);

      marks.forEach((family, idx) => {
        const card = document.createElement('div');
        const cardId = `mark-${idx}`;
        const isExpanded = expandedMarks.has(cardId);
        card.className = 'mark-family' + (isExpanded ? ' expanded' : '');
        card.id = cardId;

        const color = getColorForIndex(idx);
        const header = document.createElement('div');
        header.className = 'mark-family-header';
        header.onclick = () => toggleMark(cardId);
        header.innerHTML = `
          <div class="mark-family-badge" style="background: ${color}">
            ${getInitials(family.mark_text)}
          </div>
          <div class="mark-family-info">
            <div class="mark-family-name">${family.mark_text}</div>
            <div class="mark-family-count">${family.registrations.length} registrations</div>
          </div>
          <svg class="mark-expand-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="9 6 15 12 9 18"></polyline>
          </svg>
        `;
        card.appendChild(header);

        const classGroups = groupByClass(family.registrations);
        const classes = document.createElement('div');
        classes.className = 'mark-classes';

        classGroups.forEach(classGroup => {
          const classDiv = document.createElement('div');
          classDiv.className = 'mark-class-group';
          classDiv.innerHTML = `<div class="mark-class-header">Class ${classGroup.class} â€” ${classGroup.className}<span class="mark-class-count">${classGroup.registrations.length}</span></div>`;

          classGroup.registrations.forEach(reg => {
            const regDiv = document.createElement('div');
            regDiv.className = 'mark-registration';
            const statusClass = 'status-' + (reg.status || 'pending').toLowerCase();
            regDiv.innerHTML = `
              <div class="mark-reg-content">
                <div class="mark-reg-name">${reg.registry_name}</div>
                <div class="mark-reg-app">${reg.application_number}</div>
              </div>
              <span class="mark-reg-status ${statusClass}">${(reg.status || 'pending').toUpperCase()}</span>
              <div class="action-registry">${fmtDate(reg.registration_date || reg.application_date)}</div>
            `;
            classDiv.appendChild(regDiv);
          });
          classes.appendChild(classDiv);
        });

        card.appendChild(classes);
        container.appendChild(card);
      });
    }

    function renderPipeline() {
      const container = document.getElementById('tab-pipeline');

      const filed = allData.filter(t => t.status === 'filed').length;
      const published = allData.filter(t => t.status === 'published').length;
      const pending = allData.filter(t => t.status === 'pending').length;
      const registered = allData.filter(t => t.status === 'registered').length;
      const opposed = allData.filter(t => t.status === 'opposed').length;
      const expired = allData.filter(t => t.status === 'expired').length;

      const header = document.createElement('div');
      header.className = 'section-header';
      header.innerHTML = `
        <div class="section-dot green"></div>
        <div class="section-title">Filing Pipeline</div>
      `;
      container.appendChild(header);

      const bubbles = document.createElement('div');
      bubbles.className = 'pipeline-bubbles';
      const stages = [
        { label: 'Filed', count: filed, color: 'filed' },
        { label: 'Published', count: published, color: 'published' },
        { label: 'Pending', count: pending, color: 'pending' },
        { label: 'Registered', count: registered, color: 'registered' },
        { label: 'Opposed', count: opposed, color: 'opposed' },
        { label: 'Expired', count: expired, color: 'expired' }
      ];

      stages.forEach(stage => {
        const group = document.createElement('div');
        group.className = 'bubble-group';
        const size = Math.max(60, Math.min(120, 60 + (stage.count * 2)));
        group.innerHTML = `
          <div class="bubble bubble-${stage.color}" style="width: ${size}px; height: ${size}px; font-size: ${size / 3}px;">
            ${stage.count}
          </div>
          <div class="bubble-label">${stage.label}</div>
        `;
        bubbles.appendChild(group);
      });

      container.appendChild(bubbles);

      const classHeader = document.createElement('div');
      classHeader.className = 'section-header';
      classHeader.style.marginTop = '40px';
      classHeader.innerHTML = `
        <div class="section-dot orange"></div>
        <div class="section-title">By Nice Class</div>
      `;
      container.appendChild(classHeader);

      const classBars = document.createElement('div');
      classBars.className = 'class-bars';

      const classMap = {};
      allData.forEach(tm => {
        (tm.good_and_services || []).forEach(cls => {
          const classNum = cls.search_class?.number || 'Unknown';
          classMap[classNum] = (classMap[classNum] || 0) + 1;
        });
      });

      const sortedClasses = Object.entries(classMap)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10);

      const maxCount = Math.max(...sortedClasses.map(c => c[1]));

      sortedClasses.forEach(([classNum, count]) => {
        const item = document.createElement('div');
        item.className = 'class-bar-item';
        const percent = (count / maxCount) * 100;
        item.innerHTML = `
          <div class="class-bar-label">Class ${classNum}</div>
          <div class="class-bar">
            <div class="class-bar-fill" style="width: ${percent}%">${count}</div>
          </div>
        `;
        classBars.appendChild(item);
      });

      container.appendChild(classBars);
    }

    function renderRegistry() {
      const container = document.getElementById('tab-registry');
      const registries = groupByRegistry(allData);

      if (registries.length === 0) {
        container.innerHTML = '<div class="loading">No registries found.</div>';
        return;
      }

      const header = document.createElement('div');
      header.className = 'section-header';
      header.innerHTML = `
        <div class="section-dot purple"></div>
        <div class="section-title">Marks by Registry</div>
        <div class="badge">${registries.length}</div>
      `;
      container.appendChild(header);

      registries.forEach((reg, idx) => {
        const cardId = `registry-${idx}`;
        const isExpanded = expandedRegistries.has(cardId);

        const card = document.createElement('div');
        card.className = 'registry-card' + (isExpanded ? ' expanded' : '');
        card.id = cardId;

        const color = getColorForIndex(idx);
        const cardHeader = document.createElement('div');
        cardHeader.className = 'registry-card-header';
        cardHeader.onclick = () => toggleRegistry(cardId);

        const registered = reg.trademarks.filter(t => t.status === 'registered').length;
        const pending = reg.trademarks.filter(t => t.status !== 'registered').length;

        cardHeader.innerHTML = `
          <div class="registry-badge" style="background: ${color}">
            ${getInitials(reg.registry_name)}
          </div>
          <div class="registry-info">
            <div class="registry-name">${reg.registry_name}</div>
            <div class="registry-subtitle">${registered} registered, ${pending} pending/published</div>
          </div>
          <div class="registry-count">${reg.trademarks.length}</div>
          <svg class="registry-expand" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="9 6 15 12 9 18"></polyline>
          </svg>
        `;
        card.appendChild(cardHeader);

        const marks = document.createElement('div');
        marks.className = 'registry-marks';

        reg.trademarks.forEach(tm => {
          const item = document.createElement('div');
          item.className = 'registry-mark-item';
          const statusClass = 'status-' + (tm.status || 'pending').toLowerCase();
          item.innerHTML = `
            <div class="action-badge" style="background: ${color}">
              ${getInitials(tm.mark_text)}
            </div>
            <div class="action-content">
              <div class="action-mark">${tm.mark_text}</div>
              <div class="action-description">${tm.application_number}</div>
            </div>
            <span class="mark-reg-status ${statusClass}">${(tm.status || 'pending').toUpperCase()}</span>
          `;
          marks.appendChild(item);
        });

        card.appendChild(marks);
        container.appendChild(card);
      });
    }

    function renderRightPanel() {
      const panel = document.getElementById('right-panel');
      const actions = getActionsRequired(allData);
      const registries = new Set(allData.map(t => t.registry_name));
      const classes = new Set();
      allData.forEach(tm => {
        (tm.good_and_services || []).forEach(cls => {
          if (cls.search_class?.number) classes.add(cls.search_class.number);
        });
      });

      const topClass = Array.from(classes).sort()[0] || 'Unknown';

      panel.innerHTML = `
        <div class="panel-section">
          <div class="panel-section-title">ALERTS</div>
          <div class="alert-box">
            <div class="alert-box-title">BrandVault Alert</div>
            <div class="alert-box-text">${actions.length} marks require immediate attention. ${actions.length > 0 ? `Earliest action due in ${actions[0].daysLeft} days.` : 'All marks are current.'}</div>
          </div>
        </div>

        <div class="panel-section">
          <div class="panel-section-title">PORTFOLIO INSIGHT</div>
          <div class="insight-box">
            <div class="insight-box-text"><strong>${new Set(allData.map(t => t.mark_text)).size}</strong> registered marks across <strong>${registries.size}</strong> registries. Strongest coverage in <strong>Class ${topClass}</strong>.</div>
          </div>
        </div>

        <div class="panel-section">
          <div class="panel-section-title">DATA SOURCE</div>
          <div class="insight-box">
            <div class="insight-box-text">LawPanel Firms API. Last fetched: <strong>${new Date().toLocaleDateString()}</strong>. Run lawpanel-fetch-trademarks.js to refresh.</div>
          </div>
        </div>

        <div class="panel-section">
          <div class="panel-section-title">UPCOMING RENEWALS</div>
          <ul class="item-list" id="renewals-list"></ul>
        </div>

        <div class="panel-section">
          <div class="panel-section-title">RECENT ACTIVITY</div>
          <ul class="item-list" id="activity-list"></ul>
        </div>
      `;

      // Upcoming renewals
      const renewals = allData
        .filter(t => t.expiry_date)
        .map(t => ({
          mark: t.mark_text,
          registry: t.registry_name,
          date: t.expiry_date,
          days: daysTo(t.expiry_date),
          color: getColorForIndex(Math.random() * 10)
        }))
        .filter(r => r.days && r.days > 0 && r.days <= 365)
        .sort((a, b) => a.days - b.days)
        .slice(0, 5);

      const renewalsList = document.getElementById('renewals-list');
      renewals.forEach(r => {
        const li = document.createElement('li');
        li.className = 'item';
        li.innerHTML = `
          <div class="item-badge" style="background: ${r.color}">
            ${getInitials(r.mark)}
          </div>
          <div class="item-info">
            <div class="item-title">${r.mark}</div>
            <div class="item-subtitle">${r.registry}</div>
          </div>
          <div class="item-count">${r.days}d</div>
        `;
        renewalsList.appendChild(li);
      });

      // Recent activity
      const activity = allData
        .filter(t => t.registration_date || t.status_date)
        .map(t => ({
          mark: t.mark_text,
          registry: t.registry_name,
          status: t.status,
          date: t.registration_date || t.status_date,
          color: getColorForIndex(Math.random() * 10)
        }))
        .sort((a, b) => new Date(b.date) - new Date(a.date))
        .slice(0, 5);

      const activityList = document.getElementById('activity-list');
      activity.forEach(a => {
        const li = document.createElement('li');
        li.className = 'item';
        li.innerHTML = `
          <div class="item-badge" style="background: ${a.color}">
            ${getInitials(a.mark)}
          </div>
          <div class="item-info">
            <div class="item-title">${a.mark}</div>
            <div class="item-subtitle">${a.status ? a.status.charAt(0).toUpperCase() + a.status.slice(1) : 'Updated'} - ${fmtDate(a.date)}</div>
          </div>
        `;
        activityList.appendChild(li);
      });
    }

    // INTERACTION HANDLERS
    function switchTab(tab) {
      currentTab = tab;
      document.querySelectorAll('.tab').forEach((t, i) => {
        t.classList.toggle('active', ['actions', 'marks', 'pipeline', 'registry'][i] === tab);
      });
      document.querySelectorAll('.tab-content').forEach((c, i) => {
        c.classList.toggle('active', ['actions', 'marks', 'pipeline', 'registry'][i] === tab);
      });
    }

    function switchNav(nav) {
      document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
      event.target.closest('.nav-link').classList.add('active');
    }

    function toggleMark(cardId) {
      if (expandedMarks.has(cardId)) {
        expandedMarks.delete(cardId);
      } else {
        expandedMarks.add(cardId);
      }
      renderMarks();
    }

    function toggleRegistry(cardId) {
      if (expandedRegistries.has(cardId)) {
        expandedRegistries.delete(cardId);
      } else {
        expandedRegistries.add(cardId);
      }
      renderRegistry();
    }

    // EXPORT FUNCTIONS
    function exportCSV() {
      const rows = [['Mark', 'Registry', 'Application #', 'Status', 'Filing Date', 'Expiry Date']];
      allData.forEach(tm => {
        rows.push([
          tm.mark_text,
          tm.registry_name,
          tm.application_number,
          tm.status,
          fmtDate(tm.application_date),
          fmtDate(tm.expiry_date)
        ]);
      });

      let csv = rows.map(r => r.map(c => `"${c}"`).join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'brandvault-portfolio.csv';
      a.click();
    }

    function exportXLSX() {
      const rows = [['Mark', 'Registry', 'Application #', 'Status', 'Filing Date', 'Expiry Date']];
      allData.forEach(tm => {
        rows.push([
          tm.mark_text,
          tm.registry_name,
          tm.application_number,
          tm.status,
          fmtDate(tm.application_date),
          fmtDate(tm.expiry_date)
        ]);
      });

      const ws = XLSX.utils.aoa_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Portfolio');
      XLSX.writeFile(wb, 'brandvault-portfolio.xlsx');
    }

    function exportPDF() {
      const element = document.querySelector('.content-main');
      const opt = {
        margin: 10,
        filename: 'brandvault-portfolio.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { orientation: 'portrait', unit: 'mm', format: 'a4' }
      };
      html2pdf().set(opt).from(element).save();
    }

    function showExportMenu() {
      const menu = ['CSV', 'XLSX', 'PDF'];
      const choice = prompt('Export format:\n1. CSV\n2. XLSX\n3. PDF\n\nEnter number:', '1');
      if (choice === '1') exportCSV();
      else if (choice === '2') exportXLSX();
      else if (choice === '3') exportPDF();
    }

    // MAIN APP FUNCTION
    async function App() {
      try {
        const response = await fetch('./trademark-data.json');
        if (!response.ok) throw new Error('Failed to load data');
        const data = await response.json();

        allData = data.trademarks || [];
        if (allData.length === 0) {
          allData = data; // Fallback for direct array
        }

        // Add colors to items
        allData = allData.map((tm, idx) => ({
          ...tm,
          color: getColorForIndex(idx)
        }));

        renderStats();
        renderActions();
        renderMarks();
        renderPipeline();
        renderRegistry();
        renderRightPanel();
      } catch (error) {
        console.error('Error loading data:', error);
        document.getElementById('tab-actions').innerHTML =
          `<div class="error">Error loading trademark data: ${error.message}</div>`;
      }
    }

    // INITIALIZE
    document.addEventListener('DOMContentLoaded', App);
  </script>
</body>
</html>
